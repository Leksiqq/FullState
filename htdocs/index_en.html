<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
        <title>Net.Leksi.FullState: library to extend dependency injection container to support session context services for ASP.NET Core server</title>
        <style>
            body {
              font-family: "Lato", sans-serif;
            }
            
            .sidenav {
              height: 100%;
              -width: 200px;
              width: auto;
              position: fixed;
              z-index: 1;
              top: 0;
              left: 0;
              background-color: rgb(255, 255, 255);
              overflow-x: hidden;
              padding-top: 20px;
              font-size: smaller;
            }
            
            .sidenav a {
              padding: 6px 6px 6px 32px;
              text-decoration: none;
              display: block;
            }
            
            .sidenav span.expander {
              padding: 6px 6px 6px 32px;
              text-decoration: none;
              display: block;
            }
            
            .main {
              margin-left: 200px; /* Same as the width of the sidenav */
            }
            
            @media screen and (max-height: 450px) {
              .sidenav {padding-top: 15px;}
              .sidenav a {font-size: 18px;}
            }
            
            .indent1 {
                margin-left: 10px;
            }
            
            .indent2 {
                margin-left: 20px;
            }
            
            tr td:first-child {
              width: 0;
              white-space: nowrap;
            }
            
            table.members {
                border-collapse: collapse;
            }
            table.members td {
                border: 1px solid black;
                padding: 5px;
            }
            table:not(.members) td {
                border: initial;
                padding: 5px;
            }
            table.methods {
                border-collapse: collapse;
            }
            table.methods tr {
                border: solid gray 1px;
            }
            span.parameter {
                padding: 5px;
                background-color: lightgray;
            }
            td {
                vertical-align: top;
            }
            </style>
            <script src="https://code.jquery.com/jquery-3.6.0.min.js" lang="javascript"></script>
            <script lang="javascript">
                $(window).ready(() => {
                    $('span.expander').click(e => {
                        if($(e.target).children('span.expander-icon').hasClass('open')) {
                            $(e.target).children('span.expander-icon').removeClass('open');
                            $(e.target).children('span.expander-icon').addClass('closed');
                            $(e.target).children('span.expander-icon').html('+')
                            $(e.target).children('div').hide();
                        }
                        else {
                            $(e.target).children('span.expander-icon').removeClass('closed');
                            $(e.target).children('span.expander-icon').addClass('open');
                            $(e.target).children('span.expander-icon').html('-')
                            $(e.target).children('div').show();
                        }
                        $('.main').css('margin-left', $('.sidenav').css('width'));
                    });
                    $('span.expander').click();
                });
            </script>
    </head>
    <body>
        <div class="sidenav">
            <a href="index.html">На русском</a>
            <a style="font-size: larger;" href="#FullState">Net.Leksi.FullState</a>
            <span class="expander"><span class="expander-icon open">+</span> FullStateExtensions
                <div>
                    <a style="font-size: larger;" href="#FullStateExtensions">FullStateExtensions</a>
                    <a style="font-size: larger;" href="#FullStateExtensions.methods">Methods</a>
                </div>
            </span>
            <span class="expander"><span class="expander-icon open">+</span> FullStateOptions
                <div>
                    <a style="font-size: larger;" href="#FullStateOptions">FullStateOptions</a>
                    <a style="font-size: larger;" href="#FullStateOptions.properties">Properties</a>
                </div>
            </span>
            <span class="expander"><span class="expander-icon open">+</span> IFullState
                <div>
                    <a style="font-size: larger;" href="#IFullState">IFullState</a>
                    <a style="font-size: larger;" href="#IFullState.properties">Properties</a>
                </div>
            </span>
            <span class="expander"><span class="expander-icon open">+</span> Usage
                <div>
                    <a style="font-size: larger;" href="#DI.config">DI container configuration</a>
                    <a style="font-size: larger;" href="#App.config">Application configuration</a>
                    <a style="font-size: larger;" href="#Access">Access to services</a>
                </div>
            </span>
        </div>
        <div class="main">
            <a name="FullState"/>
            <h1>Net.Leksi.FullState</h1>
            <p>
                The library provides the standard use of the Dependency Injection mechanism in ASP.NET Core applications with persistence
                 state between requests during the session (full state). Allows session context services to be registered with the DI container and retrieved from the container in the normal way.
                 Also provides the ability to access request context services in session context service methods.
            </p>
            <a name="FullStateExtensions"/>
            <h2>Класс FullStateExtensions</h2>
            <p>
                Provides extension methods for types
                 <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.iservicecollection" target="_blank">IServiceCollection</a>
                 and <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.iapplicationbuilder" target="_blank">IApplicationBuilder</a>.
            </p>
                <script src="https://gist.github.com/Leksiqq/9c26c46546d4d7963b754440e82ac723.js"></script>
            <a name="FullStateExtensions.methods"/>
            <h2>Methods</h2>
            <table class="methods">
                <tr>
                    <td><a href="#AddFullState">AddFullState(IServiceCollection)</a></td>
                    <td>Adds the infrastructure needed for a full state server</td>
                </tr>
                <tr>
                    <td><a href="">AddFullState(IServiceCollection, Action<FullStateOptions>)</a></td>
                    <td>Adds the infrastructure needed for a full state server</td>
                </tr>
                <tr>
                    <td><a href="#AddSessional">AddSessional(IServiceCollection, Type)</a></td>
                    <td>Adds a session scoped service of the specified type to this collection</td>
                </tr>
                <tr>
                    <td><a href="#AddSessional">AddSessional(IServiceCollection, Type, Func&lt;IServiceProvider, object&gt;)</a></td>
                    <td>Adds a session-scoped service of the specified type with an implementing factory to this collection</td>
                </tr>
                <tr>
                    <td><a href="#AddSessional">AddSessional(IServiceCollection, Type, Type)</a></td>
                    <td>Adds a session-scoped service of the specified type with the specified implementation type to this collection</td>
                </tr>
                <tr>
                    <td><a href="#AddSessional">AddSessional&lt;T1, T2&gt;(IServiceCollection)</a></td>
                    <td>Adds a session-scoped service of the specified type with the specified implementation type to this collection</td>
                </tr>
                <tr>
                    <td><a href="#AddSessional">AddSessional&lt;T1, T2&gt;(IServiceCollection, Func&lt;IServiceProvider, T2&gt;)</a></td>
                    <td>Adds a service of the specified type, session-scoped, and the specified implementation type and implementation factory to this collection</td>
                </tr>
                <tr>
                    <td><a href="#AddSessional">AddSessional&lt;T1&gt;(IServiceCollection)</a></td>
                    <td>Adds a session scoped service of the specified type to this collection</td>
                </tr>
                <tr>
                    <td><a href="#AddSessional">AddSessional&lt;T1&gt;(IServiceCollection, Func&lt;IServiceProvider, T1&gt;)</a></td>
                    <td>Adds a session-scoped service of the specified type with an implementing factory to this collection</td>
                </tr>
                <tr>
                    <td><a href="">UseFullState(IApplicationBuilder)</a></td>
                    <td>Adds middleware to this application to automatically enable full state server support</td>
                </tr>
            </table>
            <a name="AddFullState"></a>
            <h3>Метод AddFullState(...)</h3>
            <p>
                Adds the infrastructure required for a full state server.
            </p>
            <script src="https://gist.github.com/Leksiqq/2cfd1f8217fd45a2653162ffdbc150ce.js"></script>
            <h4>Parameters</h4>
            <p>
                <span class="parameter">services</span> <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.iservicecollection" target="_blank"> IServiceCollection</a>
            </p>
            <p>
                Target collection.
            </p>
            <p>
                <span class="parameter">configure</span> <a href="https://docs.microsoft.com/en-us/dotnet/api/system.action-1" target="_blank">Action< /a>&lt;<a href="#FullStateOptions">FullStateOptions&gt;</a>
            </p>
            <p>
                A delegate to configure the provided set of options.
            </p>
            <h4>Return value</h4>
             <p>
                 <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.iservicecollection" target="_blank">IServiceCollection</a>
             </p>
             <p>
                 The target collection for the call chain.
             </p>

            <a name="AddSessional"></a>
            <h3>AddSessional(...) methods</h3>

            <p>
                Add to this collection a service of the specified type with limited session scope and various implementation options.
            </p>
            <script src="https://gist.github.com/Leksiqq/25451fbc4ec99218e311b791e5ea3aba.js"></script>
            <h4>Type parameters</h4>
            <p>
                <span class="parameter">TService</span>
            </p>
            <p>
                Service type.
            </p>
            <p>
                <span class="parameter">TImplementation</span>
            </p>
            <p>
                The implementation type of the service.
            </p>

            <h4>Settings</h4>
            <p>
                <span class="parameter">services</span> <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.iservicecollection" target="_blank"> IServiceCollection</a>
            </p>
            <p>
                Target collection.
            </p>
            <p>
                <span class="parameter">serviceType</span> <a href="https://docs.microsoft.com/en-us/dotnet/api/system.type" target="_blank">Type</a >
            </p>
            <p>
                Service type.
            </p>
            <p>
                <span class="parameter">implementationType</span> <a href="https://docs.microsoft.com/en-us/dotnet/api/system.type" target="_blank">Type</a >
            </p>
            <p>
                The implementation type of the service.
            </p>
            <p>
                <span class="parameter">implementationFactory</span> <a href="https://docs.microsoft.com/en-us/dotnet/api/system.func-2" target="_blank">Func< /a>&lt;<a
                href="https://docs.microsoft.com/en-us/dotnet/api/system.iserviceprovider" target="_blank">IServiceProvider</a>,
                <a href="https://docs.microsoft.com/en-us/dotnet/api/system.object" target="_blank">object</a>&gt;,
                <a href="https://docs.microsoft.com/en-us/dotnet/api/system.func-2" target="_blank">Func</a>&lt;<a
                href="https://docs.microsoft.com/en-us/dotnet/api/system.iserviceprovider" target="_blank">IServiceProvider</a>,
                TImplementation&gt;,
                <a href="https://docs.microsoft.com/en-us/dotnet/api/system.func-2" target="_blank">Func</a>&lt;<a
                href="https://docs.microsoft.com/en-us/dotnet/api/system.iserviceprovider" target="_blank">IServiceProvider</a>,
                Service&gt;
            </p>
            <p>
                The implementing factory of the service.
            </p>

            <h4>Return value</h4>
            <p>
                <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.iservicecollection" target="_blank">IServiceCollection</a>
            </p>
            <p>
                The target collection for the call chain.
            </p>

            <a name="UseFullState"/>
            <h3>UseFullState(...) method</h3>
            <p>
                Adds middleware to this application to automatically enable full state server support.
            </p>
            <script src="https://gist.github.com/Leksiqq/bf561eb13cb178fd8783eed8b0cf07ea.js"></script>
            <h4>Settings</h4>
            <p>
                <span class="parameter">app</span> <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.iapplicationbuilder" target="_blank"> IApplicationBuilder</a>
            </p>
            <p>
                Target application.
            </p>

            <h4>Return value</h4>
            <p>
                <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.iapplicationbuilder" target="_blank">IApplicationBuilder</a>
            </p>
            <p>
                The target application for the call chain.
            </p>

            <a name="FullStateOptions"/>
            <h2>Class FullStateOptions</h2>

            <p>
                Provides a set of options for configuring the infrastructure.
            </p>

            <script src="https://gist.github.com/Leksiqq/902300e69c625962ff17bcca625b56b3.js"></script>

            <a name="FullStateOptions.properties"/>
            <h2>Properties</h2>
            <table class="methods">
                <tr>
                    <td>
                        <a href="https://docs.microsoft.com/en-us/dotnet/api/system.timespan" target="_blank">TimeSpan</a> IdleTimeout
                    </td>
                    <td>
                        Specifies the length of time a session is idle before it is terminated.
                        Each session access resets the timeout. The default is 1 hour.
                    </td>
                </tr>
                <tr>
                    <td>
                        <a href="https://docs.microsoft.com/en-us/dotnet/api/system.timespan" target="_blank">TimeSpan</a> ExpirationScanFrequency
                    </td>
                    <td>
                        Specifies how often to check for terminated sessions to free their resources. The default is 1 second.
                    </td>
                </tr>
                <tr>
                    <td>
                        <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.cookiebuilder" target="_blank">CookieBuilder</a> Cookie
                    </td>
                    <td>
                        Specifies the options used to create cookies.
                        <br/>
                        <br/>Name is set to default value
                        <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.session.sessiondefaults.cookiename" target="_blank">SessionDefaults.CookieName</a>.
                        <br/>Path is set to default <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.session.sessiondefaults.cookiepath" target="_blank">SessionDefaults .CookiePath</a>.
                        <br/>SameSite is set to default <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.samesitemode" target="_blank">SameSiteMode.Lax </a>.
                        <br/>HttpOnly is <b>true</b> by default.
                        <br/>IsEssential by default <b>false</b>
                    </td>
                </tr>
            </table>
            <a name="IFullState"/>
            <h2>IFullState interface</h2>

            <p>
                Provides access to services with an Http context lifetime from services with a session lifetime.
            </p>

            <script src="https://gist.github.com/Leksiqq/a0219f20f2f07ae8027eb0613bb66374.js"></script>

            <a name="IFullState.properties"/>
            <h2>Properties</h2>
            <table class="methods">
                <tr>
                    <td>
                        <a href="https://docs.microsoft.com/en-us/dotnet/api/system.iserviceprovider" target="_blank">IServiceProvider</a> RequestServices
                    </td>
                    <td>
                        Http context service provider.
                    </td>
                </tr>
            </table>
            
            <h2>Usage</h2>

            <a name="DI.config"/>
            <h3>Configuring the DI Container</h3>

            <script src="https://gist.github.com/Leksiqq/51576e62fb5847e1ef7506780443277b.js"></script>

            <p>
                The example enables support for session context services with default options. The <code>InfoProvider</code> service is registered as a session context service and every time it is retrieved from the DI container
                will be a single stateful object within the lifetime of the session. The <code>Another</code> service registers as the Http request context service and keeps its state within
                request processing time.
            </p>

            <aname="App.config"/>
            <h3>Application Configuration</h3>

            <script src="https://gist.github.com/Leksiqq/94974139fadb4290ec9261aadf34c7d9.js"></script>

            <p>
                The example adds middleware to automatically enable support for session context services.
            </p>

            <a name="Access"/>
            <h3>Service Access</h3>

            <script src="https://gist.github.com/Leksiqq/f042dad6865185d9af276a4330fb0fce.js"></script>

            <h4>In controller and services from Http context</h4>

            <p>
                In the example, the objects <code>another1</code> and <code>another2</code> are the same object from the context of the Http request, <br/>
                <code>infoProvider1</code> and <code>infoProvider3</code> objects are the same object from the session context, <br/>
                <code>infoProvider2</code> and <code>infoProvider4</code> objects are the same object from the Http request context (<code>infoProvider1 != infoProvider2</code>).<br/>
                In the <code>infoProvider2</code>:<br/> object
                <code>another3</code> and <code>another4</code> objects are the same object from the Http request context (all <code>another...</code> are the same).
            </p>

            <h4>In services from session context</h4>
            <p>
                In the example in the object <code>infoProvider1</code>:<br/>
                object <code>another3</code> - object from session context, <br/>
                object <code>another4</code> - an object from the context of the Http request, (<code>another1 == another4 && another2 == another4</code>).<br/>
            </p>
        </div>
    </body>
</html>